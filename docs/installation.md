
# 以docker容器运行

docker run -d --name bt -v /var/log/backtest:/var/log/backtest --env-file=.env -e PORT=3180 -p 3180:3180 backtest

上述命令中，将本地的/var/log/backtest映射到容器的/var/log/backtest，并且指定环境变量PORT=3180,并且将容器的3180端口映射到本地的3180端口。如果指定了/var/log/backtest的映射，则容器的日志将输出到宿主机的/var/log/backtest目录中。

如果不指定PORT，则默认为7080，此时端口映射也应该相应修改为 -p 7080:7080。

!!!info
    这里-e PORT 3180的作用是，让容器内部的backtest服务器监听在3180端口，而-p 3180:3180则是让容器的3180端口映射到本地的3180端口，从而使得外部程序可以访问容器里的服务。

注意backtest并不支持https。如果https对您而言比较重要，请在backtest server之前增加nginx一类的服务来实现。

## 环境变量

以上述方式运行时，.env文件中需要根据实际情况，设置以下变量：

```
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=my-token
INFLUXDB_ORG=my-org
INFLUXDB_BUCKET=my-bucket
MODE=TEST
AUTO_UPGRADE=TRUE
ALLOW_PRE=FALSE
```
1. 这里的redis和influxdb是安装omega时，创建的服务器。

2. 当mode设置为TEST时，backtesting会自带少量数据，并且会往redis和influxdb中写入数据。请注意，一定只能在本地测试环境中这么使用！！
3. AUTO_UPGRADE为TRUE时，会自动更新backtest。
4. ALLOW_PRE为TRUE时，自动更新时，可能安装最新的非正式版本。

上述变量也可以通过 -e ENVAR=value 的方式传入。但是使用env-file，则可以在不删除容器的情况下进行变量修改，再重启容器即可生效。

# 本地安装运行

在命令行模式下运行以下命令：

``` console
$ pip install zillionare-backtest
```

安装完成后，通过命令启动服务：
``` console
bt start
```

终止服务：
``` console
bt stop
```

查看服务状态：
``` console
bt status
```

# 配置和配置文件

运行backtest之前，必须要给其配置数据源等一些关键信息。该文件为yaml文件，其位置和解析请参考[cfg4py](https://cfg4py.readthedocs.io/en/latest/)的规范。

您可以直接修改这里的配置文件，也可以通过设置环境变量来指定数据源。在docker容器模式下，只支持后一种方式。

```yaml
#auto generated by Cfg4Py: https://github.com/jieyu-tech/cfg4py
logging:
  version: 1
  disable_existing_loggers: false
  formatters:
    default:
      format: '%(asctime)s %(levelname)-1.1s %(name)s:%(funcName)s:%(lineno)s
        | %(message)s'
    backtest:
      format: '%(bt_date)s %(levelname)-1.1s %(name)s:%(funcName)s:%(lineno)s
        | %(message)s'
    bare:
      format: '%(message)s'
  handlers:
    console:
      class: logging.StreamHandler
      formatter: default
    default:
      class: logging.handlers.RotatingFileHandler
      formatter: default
      filename: /var/log/backtest/sys.log
      maxBytes: 10485760
      backupCount: 10
      encoding: utf-8
    entrust:
      class: logging.handlers.RotatingFileHandler
      formatter: bare
      filename: /var/log/backtest/entrust.log
      maxBytes: 10485760
      backupCount: 10
      encoding: utf-8
    trade:
      class: logging.handlers.RotatingFileHandler
      formatter: bare
      filename: /var/log/backtest/trade.log
      maxBytes: 10485760
      backupCount: 10
      encoding: utf-8
    backtest:
      class: logging.handlers.RotatingFileHandler
      formatter: backtest
      filename: /var/log/backtest/backtest.log
  loggers:
      backtest:
        level: INFO
        handlers: [backtest]
        propagate: false
  root:
    handlers:
      - console
    level: INFO
metrics:
  risk_free_rate: 0.03
  annual_days: 252
server:
  prefix: /backtest/api/trade/
auth:
  admin: bGZJGEZ
feed:
  # the only type currently supported
  type: zillionare

redis:
  dsn: redis://${REDIS_HOST}:${REDIS_PORT}
influxdb:
  url: http://${INFLUXDB_HOST}:${INFLUXDB_PORT}
  token: ${INFLUXDB_TOKEN}
  org: ${INFLUXDB_ORG}
  bucket_name: ${INFLUXDB_BUCKET_NAME}
  enable_compress: true

```
!!!Important
    注意通过容器来使用backtest时，请确保日志文件使用默认位置，即/var/log/backtest，只有这样，您才能将其映射到宿主机上的某个文件夹，因为在容器里，我们为日志文件指定的卷(VOLUME)固定为/var/log/backtest.

!!!Important
    注意配置文件中的`/backtest/api/trade/`，它用来指定backtest server监听端点的前缀，以便您在多组服务间进行区分。而最终的监听端点，则是prefix + version + command。比如，假设您的服务器地址为192.168.1.1，而端口设置为3180，当前版本为0.3，则您的[traderclient](https://zillionare.github.io/traderclient)应该指向`http://192.168.1.1:3180/backtest/api/trade/v0.3/`。您也可以通过访问`http://192.168.1.1:3180/`来得到这个监听端点地址。

!!!Info
    这里的`bt_date`并非 Python 中 logging 模块支持的模式串关键字，它来自于[omicron.core.backtestlog](https://zillionare.github.io/omicron/latest/api/omicron/#backtesting-log-facility)，该功能从omicron 2.0.0.a76版本之后提供。使用`bt_date`，生成的日志将是回测时间，而非系统时间，这对调试非常有用。

第一部分是告诉backtest如何输出日志。注意这里除了配置一般日志外，还配置了entrust和trade两个事务日志，这两个日志是供数据校验使用的。

然后是关于计算metrics时的参数配置。risk_free_rate是无风险收益率，annual_days是一年的天数，这些都是在计算一些指标，比如sharpe率等时需要的。

`auth`字段用于验证管理员身份。
`feed`字段目前用于配置数据源。当前只支持一种数据源即zillionare数据源。它要求您的系统中安装有[omega服务](https://zillionare.github.io/omega)。
随后出现的`redis`和`influxdb`字段正是omega服务中，缓存和持久化数据所需要的数据库配置。
