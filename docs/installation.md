
# 以docker容器运行

docker run -d --name bt -v /host/config:/config -e PORT=3180 -p 3180:3180 backtest

上述命令中，将本地配置文件目录/host/config映射到容器中的/config目录，并且指定环境变量PORT=3180,并且将容器的3180端口映射到本地的3180端口。这里本地配置文件目录映射是必须的，否则服务器无法启动。

如果不指定PORT，则默认为7080，此时端口映射也应该相应修改为 -p 7080:7080。

!!!info
    这里-e PORT 3180的作用是，让容器内部的backtest服务器监听在3180端口，而-p 3180:3180则是让容器的3180端口映射到本地的3180端口，从而使得外部程序可以访问容器里的服务。

在/host/config目录（这是一个host主机上的目录），创建一个名为defaults.yaml的文件，其内容见[配置文件](#配置文件)

注意backtest并不支持https。如果https对您而言比较重要，请在backtest server之前增加nginx一类的服务来实现。
# 本地安装运行

To install zillionare-backtest, run this command in your
terminal:

``` console
$ pip install zillionare-backtest
```

安装完成后，通过命令启动服务：
``` console
bt start
```

终止服务：
``` console
bt stop
```

查看服务状态：
``` console
bt status
```

# 配置文件
运行backtest之前，必须要给其配置数据源等一些关键信息。该文件为yaml文件，其位置和解析请参考[cfg4py](https://cfg4py.readthedocs.io/en/latest/)的规范。

```yaml
#auto generated by Cfg4Py: https://github.com/jieyu-tech/cfg4py
logging:
  version: 1
  disable_existing_loggers: false
  formatters:
    default:
      format: '%(asctime)s %(levelname)-1.1s %(process)d %(name)s:%(funcName)s:%(lineno)s | %(message)s'
    bare:
      format: '%(message)s'
  handlers:
    console:
      class: logging.StreamHandler
      formatter: default
    file:
      class: logging.handlers.RotatingFileHandler
      formatter: default
      filename: /var/log/backtest/backtest.log
      maxBytes: 10485760
      backupCount: 10
      encoding: utf-8
    entrust:
      class: logging.handlers.RotatingFileHandler
      formatter: bare
      filename: /var/log/backtest/entrust.log
      maxBytes: 10485760
      backupCount: 10
      encoding: utf-8
    trade:
      class: logging.handlers.RotatingFileHandler
      formatter: bare
      filename: /var/log/backtest/trade.log
      maxBytes: 10485760
      backupCount: 10
      encoding: utf-8
  loggers:
    apscheduler:
      level: INFO
    sanic:
      level: WARNING
    cfg4py:
      level: WARNING
    entrust:
      level: INFO
      handlers: [entrust]
      propagate: false
    trade:
      level: INFO
      handlers: [trade]
      propagate: false
  root:
    handlers:
      - file
    level: INFO
metrics:
  risk_free_rate: 0.03
  annual_days: 252
server:
  prefix: /backtest/api/trade/
auth:
  admin: bGZJGEZ
feed:
  # the only type currently supported
  type: zillionare

redis:
  dsn: redis://${REDIS_HOST}:${REDIS_PORT}
influxdb:
  url: http://${INFLUXDB_HOST}:${INFLUXDB_PORT}
  token: ${INFLUXDB_TOKEN}
  org: ${INFLUXDB_ORG}
  bucket_name: ${INFLUXDB_BUCKET_NAME}
  enable_compress: true

```

!!!Important
    注意配置文件中的`/backtest/api/trade/`，它用来指定backtest server监听端点的前缀，以便您在多组服务间进行区分。而最终的监听端点，则是prefix + version + command。比如，假设您的服务器地址为192.168.1.1，而端口设置为3180，当前版本为0.3，则您的[traderclient](https://zillionare.github.io/traderclient)应该指向`http://192.168.1.1:3180/backtest/api/trade/v0.3/`。您也可以通过访问`http://192.168.1.1:3180/`来得到这个监听端点地址。

第一部分是告诉backtest如何输出日志。注意这里除了配置一般日志外，还配置了entrust和trade两个事务日志，这两个日志是供数据校验使用的。

然后是关于计算metrics时的参数配置。risk_free_rate是无风险收益率，annual_days是一年的天数，这些都是在计算一些指标，比如sharpe率等时需要的。

`auth`字段用于验证管理员身份。
`feed`字段目前用于配置数据源。当前只支持一种数据源即zillionare数据源。它要求您的系统中安装有[omega服务](https://zillionare.github.io/omega)。
随后出现的`redis`和`influxdb`字段正是omega服务中，缓存和持久化数据所需要的数据库配置。
